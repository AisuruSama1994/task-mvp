import React, { useEffect, useState } from 'react';
import { Plus, Search, Eye, Send, Trash2, X } from 'lucide-react';
import api from '../services/api';
import type { Comunicado, Contacto, Grupo, ModeloComunicado } from '../types';
import Modal from '../components/Modal';

interface ComunicadoForm {
  titulo: string;
  contenido: string;
  tipo: string;
  fecha_programada: string;
  hora_programada: string;
  destinatarios_contactos: string[];
  destinatarios_grupos: string[];
  estado: string;
}

interface VistaPrevia {
  comunicado_id: string;
  titulo: string;
  tipo: string;
  total_destinatarios: number;
  previews: {
    contacto_nombre: string;
    contacto_email?: string;
    contacto_whatsapp?: string;
    mensaje_final: string;
  }[];
}

const Comunicados = () => {
  const [comunicados, setComunicados] = useState<Comunicado[]>([]);
  const [contactos, setContactos] = useState<Contacto[]>([]);
  const [grupos, setGrupos] = useState<Grupo[]>([]);
  const [modelos, setModelos] = useState<ModeloComunicado[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [selectedModelo, setSelectedModelo] = useState<string>('');
  const [previewData, setPreviewData] = useState<VistaPrevia | null>(null);

  const [showModal, setShowModal] = useState(false);
  const [showPreview, setShowPreview] = useState(false);
  const [verifyDelete, setVerifyDelete] = useState<string | null>(null);
  const [searchContacto, setSearchContacto] = useState('');
  const [searchGrupo, setSearchGrupo] = useState('');

  const [formData, setFormData] = useState<ComunicadoForm>({
    titulo: '',
    contenido: '',
    tipo: 'email',
    fecha_programada: new Date().toISOString().split('T')[0],
    hora_programada: '09:00',
    destinatarios_contactos: [],
    destinatarios_grupos: [],
    estado: 'borrador'
  });

  const filteredContactos = contactos.filter(c =>
    c.nombre.toLowerCase().includes(searchContacto.toLowerCase())
  );

  const filteredGrupos = grupos.filter(g =>
    g.nombre.toLowerCase().includes(searchGrupo.toLowerCase())
  );

  const fetchComunicados = async () => {
    try {
      const response = await api.get('/comunicados');
      setComunicados(response.data);
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const fetchContactos = async () => {
    try {
      const response = await api.get('/contactos');
      setContactos(response.data);
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const fetchGrupos = async () => {
    try {
      const response = await api.get('/grupos');
      setGrupos(response.data);
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const fetchModelos = async () => {
    try {
      const response = await api.get('/modelos-comunicados');
      setModelos(response.data);
    } catch (error) {
      console.error('Error:', error);
    }
  };

  useEffect(() => {
    const load = async () => {
      await Promise.all([fetchComunicados(), fetchContactos(), fetchGrupos(), fetchModelos()]);
      setLoading(false);
    };
    load();
  }, []);

  const handleSend = async (id: string) => {
    try {
      const comunicado = comunicados.find(c => c.id === id);
      if (!comunicado) return;

      await api.post(`/comunicados/${id}/programar`, {
        fecha_programada: comunicado.fecha_programada,
        hora_programada: comunicado.hora_programada
      });
      fetchComunicados();
      alert('Comunicado programado exitosamente. Se enviarÃ¡ automÃ¡ticamente en la fecha/hora indicada.');
    } catch (error) {
      alert('Error al programar comunicado');
    }
  };

  const handlePreview = async (id: string) => {
    try {
      const response = await api.post(`/comunicados/${id}/vista-previa`);
      setPreviewData(response.data);
      setShowPreview(true);
    } catch (error) {
      alert('Error en vista previa');
    }
  };

  const handleSend = async (id: string) => {
    try {
      await api.post(`/comunicados/${id}/enviar-ahora`);
      fetchComunicados();
      alert('Comunicado programado');
    } catch (error) {
      alert('Error al enviar');
    }
  };

  const handleDelete = async (id: string) => {
    try {
      await api.delete(`/comunicados/${id}`);
      setVerifyDelete(null);
      fetchComunicados();
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await api.post('/comunicados', formData);
      setShowModal(false);
      setFormData({
        titulo: '',
        contenido: '',
        tipo: 'email',
        fecha_programada: new Date().toISOString().split('T')[0],
        hora_programada: '09:00',
        destinatarios_contactos: [],
        destinatarios_grupos: [],
        estado: 'borrador'
      });
      setSearchContacto('');
      setSearchGrupo('');
      setSelectedModelo('');
      fetchComunicados();
    } catch (error) {
      alert('Error al guardar');
    }
  };

  const toggleContacto = (id: string) => {
    setFormData(prev => ({
      ...prev,
      destinatarios_contactos: prev.destinatarios_contactos.includes(id)
        ? prev.destinatarios_contactos.filter(x => x !== id)
        : [...prev.destinatarios_contactos, id]
    }));
  };

  const toggleGrupo = (id: string) => {
    setFormData(prev => ({
      ...prev,
      destinatarios_grupos: prev.destinatarios_grupos.includes(id)
        ? prev.destinatarios_grupos.filter(x => x !== id)
        : [...prev.destinatarios_grupos, id]
    }));
  };

  const removeContacto = (id: string) => {
    setFormData(prev => ({
      ...prev,
      destinatarios_contactos: prev.destinatarios_contactos.filter(x => x !== id)
    }));
  };

  const removeGrupo = (id: string) => {
    setFormData(prev => ({
      ...prev,
      destinatarios_grupos: prev.destinatarios_grupos.filter(x => x !== id)
    }));
  };

  const filtered = comunicados.filter(c =>
    c.titulo.toLowerCase().includes(search.toLowerCase())
  );

  const selectedContactosNames = contactos
    .filter(c => formData.destinatarios_contactos.includes(c.id))
    .map(c => c.nombre);

  const selectedGruposNames = grupos
    .filter(g => formData.destinatarios_grupos.includes(g.id))
    .map(g => g.nombre);

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-800 dark:text-white">Comunicados</h2>
          <p className="text-gray-500 dark:text-gray-400 text-sm">EnvÃ­a recordatorios por Email o WhatsApp</p>
        </div>
        <button
          onClick={() => setShowModal(true)}
          className="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
        >
          <Plus className="w-4 h-4 mr-2" />
          Nuevo Comunicado
        </button>
      </div>

      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
        <input
          type="text"
          placeholder="Buscar comunicados..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800"
        />
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50 dark:bg-gray-700/50">
            <tr>
              <th className="p-4 text-left text-sm font-medium">TÃ­tulo</th>
              <th className="p-4 text-left text-sm font-medium">Tipo</th>
              <th className="p-4 text-left text-sm font-medium">Programado</th>
              <th className="p-4 text-left text-sm font-medium">Estado</th>
              <th className="p-4 text-right text-sm font-medium">Acciones</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
            {loading ? (
              <tr><td colSpan={5} className="p-8 text-center text-gray-500">Cargando...</td></tr>
            ) : filtered.length === 0 ? (
              <tr><td colSpan={5} className="p-8 text-center text-gray-500">No hay comunicados</td></tr>
            ) : (
              filtered.map((c) => (
                <tr key={c.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                  <td className="p-4">
                    <div className="font-medium">{c.titulo}</div>
                    <p className="text-sm text-gray-600 truncate">{c.contenido.substring(0, 50)}...</p>
                  </td>
                  <td className="p-4 text-sm">{c.tipo}</td>
                  <td className="p-4 text-sm">{c.fecha_programada || '-'}</td>
                  <td className="p-4 text-sm">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${c.estado === 'enviado' ? 'bg-green-100 text-green-800' :
                      c.estado === 'programado' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                      {c.estado}
                    </span>
                  </td>
                  <td className="p-4 text-right flex justify-end gap-2">
                    <button onClick={() => handlePreview(c.id)} className="text-blue-600">
                      <Eye className="w-4 h-4" />
                    </button>
                    {c.estado === 'borrador' && (
                      <button onClick={() => handleSend(c.id)} className="text-green-600">
                        <Send className="w-4 h-4" />
                      </button>
                    )}
                    <button onClick={() => setVerifyDelete(c.id)} className="text-red-600">
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <Modal isOpen={showModal} onClose={() => { setShowModal(false); setSelectedModelo(''); }} title="Nuevo Comunicado">
        <form onSubmit={handleSubmit} className="space-y-4 max-h-[32rem] overflow-y-auto">

          {/* Cargar desde Modelo */}
          <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
            <label className="block text-sm font-medium mb-2">
              ðŸ“‹ Cargar desde Modelo (Opcional)
            </label>
            <select
              value={selectedModelo}
              onChange={(e) => handleLoadModelo(e.target.value)}
              className="w-full p-2 border rounded bg-white dark:bg-gray-700"
            >
              <option value="">-- Selecciona un modelo --</option>
              {modelos.map(m => (
                <option key={m.id} value={m.id}>
                  {m.nombre} ({m.tipo})
                </option>
              ))}
            </select>
            <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
              Selecciona un modelo para cargar su contenido. Puedes editarlo despuÃ©s.
            </p>
          </div>

          <input required value={formData.titulo} onChange={(e) => setFormData({ ...formData, titulo: e.target.value })} placeholder="TÃ­tulo" className="w-full p-2 border rounded bg-white dark:bg-gray-700" />
          <select value={formData.tipo} onChange={(e) => setFormData({ ...formData, tipo: e.target.value })} className="w-full p-2 border rounded bg-white dark:bg-gray-700">
            <option value="email">ðŸ“§ Email</option>
            <option value="whatsapp">ðŸ’¬ WhatsApp</option>
            <option value="ambos">ðŸ“§ðŸ’¬ Ambos</option>
          </select>
          <textarea required value={formData.contenido} onChange={(e) => setFormData({ ...formData, contenido: e.target.value })} placeholder="Contenido (usa {{nombre}}, {{email}}, {{whatsapp}})" className="w-full p-2 border rounded bg-white dark:bg-gray-700" rows={4} />
          <div className="grid grid-cols-2 gap-4">
            <input type="date" value={formData.fecha_programada} onChange={(e) => setFormData({ ...formData, fecha_programada: e.target.value })} className="w-full p-2 border rounded bg-white dark:bg-gray-700" />
            <input type="time" value={formData.hora_programada} onChange={(e) => setFormData({ ...formData, hora_programada: e.target.value })} className="w-full p-2 border rounded bg-white dark:bg-gray-700" />
          </div>

          {/* Contactos con Buscador */}
          <div>
            <label className="block text-sm font-medium mb-2">Contactos Individuales</label>
            <div className="relative mb-2">
              <Search className="absolute left-2 top-2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                placeholder="Buscar contacto..."
                value={searchContacto}
                onChange={(e) => setSearchContacto(e.target.value)}
                className="w-full pl-8 p-2 border rounded bg-white dark:bg-gray-700 text-sm"
              />
            </div>
            {selectedContactosNames.length > 0 && (
              <div className="flex flex-wrap gap-2 mb-2">
                {selectedContactosNames.map(nombre => (
                  <span key={nombre} className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">
                    {nombre}
                    <button
                      type="button"
                      onClick={() => removeContacto(contactos.find(c => c.nombre === nombre)!.id)}
                      className="hover:text-blue-600"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </span>
                ))}
              </div>
            )}
            <div className="border rounded p-2 max-h-40 overflow-y-auto space-y-1">
              {filteredContactos.length === 0 ? (
                <p className="text-xs text-gray-500">No hay contactos</p>
              ) : (
                filteredContactos.map(c => (
                  <label key={c.id} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 p-1 rounded">
                    <input
                      type="checkbox"
                      checked={formData.destinatarios_contactos.includes(c.id)}
                      onChange={() => toggleContacto(c.id)}
                      className="rounded"
                    />
                    <span>{c.nombre}</span>
                  </label>
                ))
              )}
            </div>
          </div>

          {/* Grupos con Buscador */}
          <div>
            <label className="block text-sm font-medium mb-2">Grupos</label>
            <div className="relative mb-2">
              <Search className="absolute left-2 top-2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                placeholder="Buscar grupo..."
                value={searchGrupo}
                onChange={(e) => setSearchGrupo(e.target.value)}
                className="w-full pl-8 p-2 border rounded bg-white dark:bg-gray-700 text-sm"
              />
            </div>
            {selectedGruposNames.length > 0 && (
              <div className="flex flex-wrap gap-2 mb-2">
                {selectedGruposNames.map(nombre => (
                  <span key={nombre} className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-xs">
                    {nombre}
                    <button
                      type="button"
                      onClick={() => removeGrupo(grupos.find(g => g.nombre === nombre)!.id)}
                      className="hover:text-green-600"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </span>
                ))}
              </div>
            )}
            <div className="border rounded p-2 max-h-40 overflow-y-auto space-y-1">
              {filteredGrupos.length === 0 ? (
                <p className="text-xs text-gray-500">No hay grupos</p>
              ) : (
                filteredGrupos.map(g => (
                  <label key={g.id} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 p-1 rounded">
                    <input
                      type="checkbox"
                      checked={formData.destinatarios_grupos.includes(g.id)}
                      onChange={() => toggleGrupo(g.id)}
                      className="rounded"
                    />
                    <span>{g.nombre}</span>
                  </label>
                ))
              )}
            </div>
          </div>

          <div className="flex gap-2 pt-4">
            <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Crear</button>
            <button type="button" onClick={() => { setShowModal(false); setSelectedModelo(''); }} className="flex-1 bg-gray-300 dark:bg-gray-600 p-2 rounded">Cancelar</button>
          </div>
        </form>
      </Modal>

      <Modal isOpen={showPreview} onClose={() => { setShowPreview(false); setPreviewData(null); }} title="Vista Previa del Comunicado">
        {previewData && (
          <div className="space-y-4">
            <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded">
              <h3 className="font-semibold text-lg">{previewData.titulo}</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                Tipo: {previewData.tipo} â€¢ Total destinatarios: {previewData.total_destinatarios}
              </p>
            </div>

            <div>
              <h4 className="font-medium mb-2">Vista previa para los primeros destinatarios:</h4>
              <div className="space-y-3">
                {previewData.previews.map((preview, idx) => (
                  <div key={idx} className="border border-gray-200 dark:border-gray-600 rounded p-3 bg-white dark:bg-gray-800">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="font-medium">{preview.contacto_nombre}</span>
                      {preview.contacto_email && (
                        <span className="text-xs text-gray-500">ðŸ“§ {preview.contacto_email}</span>
                      )}
                      {preview.contacto_whatsapp && (
                        <span className="text-xs text-gray-500">ðŸ’¬ {preview.contacto_whatsapp}</span>
                      )}
                    </div>
                    <div className="text-sm bg-gray-50 dark:bg-gray-700 p-2 rounded whitespace-pre-wrap">
                      {preview.mensaje_final}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {previewData.total_destinatarios > previewData.previews.length && (
              <p className="text-xs text-gray-500 text-center">
                Mostrando {previewData.previews.length} de {previewData.total_destinatarios} destinatarios
              </p>
            )}
          </div>
        )}
      </Modal>

      {verifyDelete && <Modal isOpen onClose={() => setVerifyDelete(null)} title="Confirmar">
        <p className="mb-4">Â¿Eliminar comunicado?</p>
        <div className="flex gap-2">
          <button onClick={() => handleDelete(verifyDelete)} className="flex-1 bg-red-600 text-white p-2 rounded">Eliminar</button>
          <button onClick={() => setVerifyDelete(null)} className="flex-1 bg-gray-300 dark:bg-gray-600 p-2 rounded">Cancelar</button>
        </div>
      </Modal>}
    </div>
  );
};

export default Comunicados;
